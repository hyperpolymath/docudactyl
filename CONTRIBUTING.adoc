// SPDX-License-Identifier: PMPL-1.0-or-later
= Contributing to Docudactyl

== Getting Started

1. Fork the repository
2. Create a feature branch from `main`
3. Sign off commits (`git commit -s`)
4. Submit a pull request

== Architecture Overview

Docudactyl is a multi-format HPC document extraction engine. The hot path is:

----
Chapel (HPC orchestrator) -> Zig FFI (C ABI wrapper) -> C libraries (Poppler, Tesseract, FFmpeg, etc.)
----

=== Key Directories

[cols="1,3"]
|===
|Path |Purpose

|`src/chapel/`
|Chapel HPC modules (main engine)

|`ffi/zig/src/`
|Zig FFI layer (links against C libraries)

|`src/Docudactyl/ABI/`
|Idris2 formal ABI proofs

|`generated/abi/`
|Auto-generated C header

|`src/ocaml/`
|Offline Scheme transformer (not in hot path)

|`src/ada/`
|Terminal UI for document inspection

|`src/julia/`
|Legacy (replaced by Chapel HPC pipeline)
|===

== Build & Test

[source,bash]
----
just deps-check      # Verify all dependencies
just build-hpc       # Build Zig FFI + Chapel binary
just test-hpc        # Run all HPC tests
just test-ffi        # Zig integration tests only
just test-ocaml      # OCaml tests only
just build-idris     # Verify Idris2 ABI proofs compile
----

== Commit Guidelines

* Conventional commits: `type(scope): description`
* Sign all commits (DCO required)
* Atomic, focused commits
* Run `just test-hpc` before pushing

== Code Standards

=== Zig FFI

* No `@panic` in release builds -- return error codes via C ABI
* All handle operations must check for null
* All C-exported functions prefixed `ddac_`
* Flat C structs only at FFI boundary (no pointers to managed memory)
* Optional dependencies (ONNX Runtime, PaddleOCR, CUDA) loaded via `dlopen`, never linked at compile time

=== Idris2 ABI

* **BANNED**: `believe_me`, `assert_total`, `assert_smaller`, `unsafePerformIO`, `Admitted`
* All proofs must be genuine -- no escape hatches
* Struct size and alignment proofs required for every FFI type
* Enum conversions must be proven injective

=== Chapel

* All `forall` loops must use `DynamicIters` for load balancing
* Config constants are `config const` (runtime-tunable without recompilation)
* Per-locale resource management with proper cleanup in `defer`

=== General

* SPDX header: `PMPL-1.0-or-later` on all files
* Author: `Jonathan D.A. Jewell <jonathan.jewell@open.ac.uk>`
* Copyright: `Copyright (c) 2026 Jonathan D.A. Jewell (hyperpolymath) <jonathan.jewell@open.ac.uk>`
* Use `Containerfile` (never `Dockerfile`), `Podman` (never `Docker`)

== Adding a New Content Type

1. Add `ContentKind` variant in `src/Docudactyl/ABI/Types.idr`
2. Add magic-byte detection in `ffi/zig/src/conduit.zig`
3. Add parser function in `ffi/zig/src/docudactyl_ffi.zig`
4. Add dispatch case in `src/chapel/ContentType.chpl`
5. Update `generated/abi/docudactyl_ffi.h`
6. Add integration test in `ffi/zig/test/integration_test.zig`
7. Update `.machine_readable/STATE.scm`

== License

Contributions licensed under PMPL-1.0-or-later (Palimpsest License).
